<script>
import { debounce, cloneDeep, isEqual } from 'lodash';
import ActivityFilter from '../filters/activity_filter.vue';
import ProjectFilter from '../filters/project_filter.vue';
import ProjectFilterDeprecated from '../filters/project_filter_deprecated.vue';
import ScannerFilter from '../filters/scanner_filter.vue';
import SimpleFilter from '../filters/simple_filter.vue';
import { FILTERS } from './constants';

const { ACTIVITY, TOOL_VENDOR, PROJECT } = FILTERS;

export default {
  components: {
    SimpleFilter,
    ScannerFilter,
    ActivityFilter,
    ProjectFilter,
    ProjectFilterDeprecated,
  },
  props: {
    filters: {
      type: Array,
      required: true,
    },
  },
  data() {
    return {
      filterQuery: {},
    };
  },
  methods: {
    getComponentType(filter) {
      switch (filter) {
        case TOOL_VENDOR:
          return ScannerFilter;
        case ACTIVITY:
          return ActivityFilter;
        case PROJECT:
          return ProjectFilter;
        default:
          return SimpleFilter;
      }
    },
    updateFilterQuery(query) {
      const oldQuery = cloneDeep(this.filterQuery);
      this.filterQuery = { ...this.filterQuery, ...query };
      // Don't emit if the filters didn't change because it will trigger the GraphQL queries to run.
      if (!isEqual(oldQuery, this.filterQuery)) {
        this.emitFilterChange();
      }
    },
    // When this component is first shown, every filter will emit its own @filter-changed event at
    // the same time, which will trigger this method multiple times. We'll debounce it so that it
    // only runs once.
    emitFilterChange: debounce(function emit() {
      this.$emit('filters-changed', this.filterQuery);
    }),
  },
};
</script>

<template>
  <div
    class="vulnerability-report-filters gl-p-5 gl-bg-gray-10 gl-border-b-1 gl-border-b-solid gl-border-b-gray-100"
  >
    <component
      :is="getComponentType(filter)"
      v-for="filter in filters"
      :key="filter.id"
      :filter="filter"
      :data-testid="filter.id"
      @filter-changed="updateFilterQuery"
    />
  </div>
</template>
